<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFC Inventory Web</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    .lang { position: absolute; top: 10px; right: 10px; }
    .page { display: none; }
    .visible { display: block; }
    table { margin: auto; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 12px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    input[type="text"], input[type="number"] { padding: 6px 10px; font-size: 16px; }
  </style>
</head>
<body>

<div class="lang">
  <select id="lang" onchange="setLang(this.value)">
    <option value="en">English</option>
    <option value="th">‡πÑ‡∏ó‡∏¢</option>
  </select>
</div>

<!-- Main Page -->
<div id="main" class="page visible">
  <h1 id="title">Select Mode</h1>
  <button onclick="showPage('customer')">Customer</button>
  <button onclick="askAdmin()">Admin</button>
</div>

<!-- Customer Page -->
<div id="customer" class="page">
  <h2 id="scanLabel">Scan or Type a Product</h2>
  <button id="nfcScanBtn" onclick="startNFC()">üì∂ Scan NFC Tag</button>
  <br><br>
  <input list="products" id="productInput" placeholder="Type product name (A, B, C)" autocomplete="off" />
  <datalist id="products">
    <option value="Product A (‡∏ø10)"></option>
    <option value="Product B (‡∏ø15)"></option>
    <option value="Product C (‡∏ø20)"></option>
  </datalist>
  <button onclick="manualSelect()">‚ûï Add</button>

  <div id="summary"></div>
  <button onclick="submitOrder()" id="submitText">Submit Order</button>
  <br><button onclick="backHome()">‚¨ÖÔ∏è Back</button>
</div>

<!-- Admin Page -->
<div id="admin" class="page">
  <h2 id="adminStockLabel">Current Stock</h2>
  <div id="stockTable"></div>

  <h3 id="editStockLabel">Edit Stock</h3>
  <select id="stockItem">
    <option value="A">Product A</option>
    <option value="B">Product B</option>
    <option value="C">Product C</option>
  </select>
  <input type="number" id="stockQty" placeholder="Amount" />
  <button onclick="addStock()">Add</button>
  <button onclick="removeStock()">Remove</button>
  <br><br>
  <button onclick="showPage('server')">üì¶ Server</button>
  <br><button onclick="backHome()">‚¨ÖÔ∏è Back</button>
</div>

<!-- Server Page -->
<div id="server" class="page">
  <h2>üìã Server Log</h2>
  <div id="logBox" style="max-height: 400px; overflow-y: auto; text-align: left; margin: 0 auto; width: 90%;"></div>
  <br><button onclick="backHome()">‚¨ÖÔ∏è Back</button>
</div>

<script>
  const i18n = {
    en: {
      title: "Select Mode", scan: "Scan or Type a Product", submit: "Submit Order",
      adminStock: "Current Stock", editStock: "Edit Stock"
    },
    th: {
      title: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î", scan: "‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", submit: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
      adminStock: "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á", editStock: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å"
    }
  };

  function setLang(lang) {
    localStorage.setItem("lang", lang);
    document.getElementById("title").innerText = i18n[lang].title;
    document.getElementById("scanLabel").innerText = i18n[lang].scan;
    document.getElementById("submitText").innerText = i18n[lang].submit;
    document.getElementById("adminStockLabel").innerText = i18n[lang].adminStock;
    document.getElementById("editStockLabel").innerText = i18n[lang].editStock;
  }

  setLang(localStorage.getItem("lang") || "en");
  document.getElementById("lang").value = localStorage.getItem("lang") || "en";

  const products = {
    "04A2242B7C2980": { name: "Product A", price: 10, key: "A" },
    "047F58A47C2980": { name: "Product B", price: 15, key: "B" },
    "04B3192B7C2980": { name: "Product C", price: 20, key: "C" }
  };

  // For autocomplete (map short names or full product names)
  const nameMap = {
    "Product A": products["04A2242B7C2980"],
    "Product B": products["047F58A47C2980"],
    "Product C": products["04B3192B7C2980"]
  };

  let stock = { A: 10, B: 10, C: 10 };
  let order = [];
  let logs = [];

  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("visible"));
    document.getElementById(id).classList.add("visible");
    if (id === "admin") updateStockView();
    if (id === "server") updateLogView();
    if (id === "customer") updateSummary();
  }

  function backHome() {
    showPage("main");
  }

  function askAdmin() {
    const pass = prompt("Enter Admin Passcode:");
    if (pass === "12345") showPage("admin");
    else alert("Incorrect passcode");
  }

  // NFC scanning
  async function startNFC() {
    if (!("NDEFReader" in window)) {
      alert("Web NFC is not supported on this device/browser.");
      return;
    }
    const nfcScanBtn = document.getElementById("nfcScanBtn");
    nfcScanBtn.disabled = true;
    nfcScanBtn.textContent = "üì∂ Scanning...";
    try {
      const ndef = new NDEFReader();
      await ndef.scan();
      ndef.onreadingerror = () => {
        alert("NFC reading error. Please try again.");
        nfcScanBtn.disabled = false;
        nfcScanBtn.textContent = "üì∂ Scan NFC Tag";
      };
      ndef.onreading = event => {
        const tagId = [...event.serialNumber].map(b => b.toString(16).padStart(2,"0")).join("").toUpperCase();
        // Some devices report serialNumber differently; fallback to event.serialNumber directly:
        const id = event.serialNumber ? event.serialNumber.toUpperCase() : tagId;
        processNfcId(id);
        nfcScanBtn.disabled = false;
        nfcScanBtn.textContent = "üì∂ Scan NFC Tag";
      };
    } catch(error) {
      alert("NFC scan failed or canceled: " + error);
      nfcScanBtn.disabled = false;
      nfcScanBtn.textContent = "üì∂ Scan NFC Tag";
    }
  }

  function processNfcId(nfcID) {
    if (!products[nfcID]) {
      alert("Unknown NFC Tag: " + nfcID);
      return;
    }
    const product = products[nfcID];
    const qty = parseInt(prompt(`Enter quantity for ${product.name}`));
    if (!qty || qty <= 0) return;
    order.push({ ...product, qty });
    updateSummary();
  }

  // Manual autocomplete select
  function manualSelect() {
    const input = document.getElementById("productInput").value.trim();
    if (!input) return;
    // Extract product name only from input, e.g. "Product A (‡∏ø10)" ‚Üí "Product A"
    const matched = input.match(/^Product [ABC]/i);
    if (!matched) {
      alert("Invalid product name. Type A, B, or C.");
      return;
    }
    const productName = matched[0];
    const product = nameMap[productName];
    if (!product) {
      alert("Product not found.");
      return;
    }
    const qty = parseInt(prompt(`Enter quantity for ${product.name}`));
    if (!qty || qty <= 0) return;
    order.push({ ...product, qty });
    updateSummary();
    // Clear input after adding
    document.getElementById("productInput").value = "";
  }

  function updateSummary() {
    if(order.length === 0) {
      document.getElementById("summary").innerHTML = "<p><em>No items added yet.</em></p>";
      return;
    }
    let html = "<h3>Summary</h3><table><tr><th>Item</th><th>Qty</th><th>Price</th></tr>";
    order.forEach(o => {
      html += `<tr><td>${o.name}</td><td>${o.qty}</td><td>‡∏ø${o.qty * o.price}</td></tr>`;
    });
    html += "</table>";
    document.getElementById("summary").innerHTML = html;
  }

  function submitOrder() {
    if(order.length === 0) {
      alert("No items to submit.");
      return;
    }
    order.forEach(o => {
      stock[o.key] = (stock[o.key] || 0) - o.qty;
      logs.push(`${timestamp()} [Customer] Ordered ${o.qty}x ${o.name}`);
    });
    alert("Order Submitted!");
    order = [];
    updateSummary();
  }

  function updateStockView() {
    let html = "<table><tr><th>Item</th><th>Quantity</th></tr>";
    Object.entries(stock).forEach(([key, qty]) => {
      html += `<tr><td>Product ${key}</td><td>${qty}</td></tr>`;
    });
    html += "</table>";
    document.getElementById("stockTable").innerHTML = html;
  }

  function addStock() {
    const key = document.getElementById("stockItem").value;
    const qty = parseInt(document.getElementById("stockQty").value);
    if (!qty || qty <= 0) return alert("Enter valid amount > 0");
    stock[key] = (stock[key] || 0) + qty;
    logs.push(`${timestamp()} [Admin] Added ${qty}x Product ${key}`);
    updateStockView();
  }

  function removeStock() {
    const key = document.getElementById("stockItem").value;
    const qty = parseInt(document.getElementById("stockQty").value);
    if (!qty || qty <= 0) return alert("Enter valid amount > 0");
    stock[key] = Math.max(0, (stock[key] || 0) - qty);
    logs.push(`${timestamp()} [Admin] Removed ${qty}x Product ${key}`);
    updateStockView();
  }

  function updateLogView() {
    if(logs.length === 0) {
      document.getElementById("logBox").innerHTML = "<p><em>No logs yet.</em></p>";
      return;
    }
    document.getElementById("logBox").innerHTML = logs.map(log => `<div>${log}</div>`).join("");
  }

  function timestamp() {
    const d = new Date();
    return d.toLocaleString();
  }
</script>

</body>
</html>
